<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Entregas</title>
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; padding-bottom: 90px; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-primary { background-color: #1E40AF; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #1E3A8A; transform: scale(1.01); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background-color: #93C5FD; cursor: not-allowed; transform: none; }
        
        .btn-outline { background-color: white; color: #1E40AF; border: 2px solid #1E40AF; }
        
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: #1E40AF; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toggle Switch */
        .switch-container { display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px; border-radius: 12px; border: 1px solid #e5e7eb; transition: all 0.3s; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #9CA3AF; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #1E40AF; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Menu Inferior */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); max-width: 28rem; margin: 0 auto; }
        @media (min-width: 768px) { .bottom-nav { border-radius: 0 0 1.5rem 1.5rem; } }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #9CA3AF; cursor: pointer; flex: 1; height: 100%; }
        .nav-item.active { color: #1E40AF; font-weight: bold; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }

        .input-readonly { background-color: #F3F4F6; color: #4B5563; cursor: not-allowed; }
        .app-container { width: 100%; min-height: 100vh; background-color: white; padding-bottom: 80px; }
        @media (min-width: 768px) { .app-container { max-width: 28rem; min-height: auto; height: 90vh; border-radius: 1.5rem; overflow: hidden; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; } body { display: flex; align-items: center; justify-content: center; min-height: 100vh; } }

        /* Dropdown */
        .custom-select-btn { width: 100%; background: white; border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.875rem; text-align: left; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .custom-select-btn:active { background-color: #F9FAFB; }
        .custom-options { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E5E7EB; border-radius: 0.5rem; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 40; overflow: hidden; display: none; }
        .custom-options.show { display: block; animation: fadeIn 0.2s; }
        .custom-option { padding: 10px; font-size: 0.875rem; cursor: pointer; border-bottom: 1px solid #F3F4F6; display: flex; align-items: center; gap: 8px; }
        .custom-option:hover { background-color: #EFF6FF; color: #1E40AF; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">

    <script>
        // ---------------------------------------------------------
        // CHAVES DO SISTEMA (COM .TRIM() PARA SEGURAN√áA)
        // ---------------------------------------------------------
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co'.trim(); 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJvZnBubmlqa2hnc2phcml4b3loZyIsImJvbGUiOiJhbm9uIiwiaWF0IjoxNzY1MDY1Mjc2LCJleHAiOjIwODA2NDEyNzZ9.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU'.trim();
        const MAKE_WEBHOOK_URL = ""; 

        // Inicializa Supabase
        let sbClient = null;
        try {
            sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.error("Erro ao iniciar Supabase:", e);
        }

        const CIDADE_FIXA = "Mossor√≥, Rio Grande do Norte, Brasil"; 
        const NUMERO_ADMIN = "5584982005039"; 
        const PRECO_BASE = 6.00; const PRECO_POR_KM = 1.80; const TAXA_RETORNO = 0.70; const TAXA_FIXA_CENTRAL = 0.50;

        let userSession = null;
        let userProfile = null;
        let distanciaFinal = 0; let valorFinal = 0;

        // VERIFICA SESS√ÉO AO ABRIR
        window.onload = async function() {
            const globalLoad = document.getElementById('global-loading');
            try {
                if(!sbClient) throw new Error("Cliente DB nulo");
                const { data: { session } } = await sbClient.auth.getSession();
                if (session) {
                    userSession = session;
                    await carregarPerfil();
                    showScreen('app');
                } else {
                    showScreen('welcome');
                }
            } catch(e) {
                console.error(e);
                showScreen('welcome');
            } finally {
                if(globalLoad) globalLoad.style.display = 'none';
            }
        };

        // --- FUN√á√ÉO DE SEGURAN√áA PARA UI ---
        function safeText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }
    </script>

    <!-- LOADING GLOBAL -->
    <div id="global-loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100]">
        <div class="spinner w-10 h-10 border-4 mb-4"></div>
        <p class="text-gray-500 text-sm font-bold">Carregando Drop...</p>
    </div>

    <!-- TELA 1: BOAS-VINDAS -->
    <div id="screen-welcome" class="app-container p-8 text-center fade-in flex flex-col justify-center">
        <div class="mb-8">
            <div class="inline-block p-5 rounded-full bg-blue-50 text-blue-700 mb-4 shadow-sm"><i class="fas fa-box-open text-5xl"></i></div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Drop Entregas</h1>
            <p class="text-gray-500 text-sm">Log√≠stica r√°pida para seu neg√≥cio.</p>
        </div>
        <div class="space-y-4">
            <button onclick="showScreen('register')" class="w-full btn-primary font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3">
                <i class="fas fa-store"></i> Cadastrar Estabelecimento
            </button>
            <button onclick="showScreen('login')" class="w-full btn-outline font-bold py-4 rounded-xl shadow-sm flex items-center justify-center gap-3">
                <i class="fas fa-lock"></i> Acessar Conta
            </button>
        </div>
        <p class="mt-8 text-xs text-gray-400">Vers√£o Final 29.0</p>
    </div>

    <!-- TELA 2: CADASTRO -->
    <div id="screen-register" class="hidden app-container p-6 fade-in relative">
        <button onclick="showScreen('welcome')" class="absolute top-4 left-4 text-gray-400 hover:text-blue-700"><i class="fas fa-arrow-left text-xl"></i></button>
        <div class="text-center mb-6 mt-4"><h2 class="text-xl font-bold text-gray-800">Novo Parceiro</h2></div>
        
        <div class="space-y-4 pb-10">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <p class="text-[10px] uppercase font-bold text-blue-600 mb-2">DADOS DO ESTABELECIMENTO</p>
                <div class="space-y-3">
                    <input type="text" id="reg-nome-loja" class="w-full bg-white border rounded-lg p-3 text-sm outline-none focus:border-blue-600" placeholder="Ex: Pizzaria Sabor & Arte">
                    <input type="text" id="reg-zap-loja" class="w-full bg-white border rounded-lg p-3 text-sm outline-none focus:border-blue-600" placeholder="WhatsApp Loja (Ex: 84 99999-9999)">
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-[10px] uppercase font-bold text-gray-500 mb-2">RESPONS√ÅVEL</p>
                <div class="space-y-3">
                    <input type="text" id="reg-nome-resp" class="w-full bg-white border rounded-lg p-3 text-sm outline-none focus:border-blue-600" placeholder="Ex: Jo√£o da Silva">
                    <input type="text" id="reg-zap-resp" class="w-full bg-white border rounded-lg p-3 text-sm outline-none focus:border-blue-600" placeholder="WhatsApp Pessoal (Ex: 84 98877-6655)">
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 relative">
                <p class="text-[10px] uppercase font-bold text-gray-500 mb-2">ENDERE√áO FIXO DE COLETA</p>
                <div class="relative mb-3">
                    <input type="text" id="reg-cep" onblur="buscarCep('reg')" class="w-full bg-white border rounded-lg p-3 text-sm pl-10 outline-none focus:border-blue-600" placeholder="CEP (00000-000)">
                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                </div>
                <div class="space-y-3">
                    <input type="text" id="reg-rua" class="w-full bg-gray-100 border rounded-lg p-3 text-sm input-readonly" placeholder="Rua" readonly>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-1"><input type="text" id="reg-num" class="w-full bg-white border border-blue-300 rounded-lg p-3 text-sm font-bold outline-none focus:border-blue-600" placeholder="Ex: 100A"></div>
                        <div class="col-span-2"><input type="text" id="reg-bairro" class="w-full bg-gray-100 border rounded-lg p-3 text-sm input-readonly" placeholder="Bairro" readonly></div>
                    </div>
                    <input type="text" id="reg-cidade" class="w-full bg-gray-100 border rounded-lg p-3 text-sm input-readonly" placeholder="Cidade" readonly>
                </div>
            </div>

            <div class="border-t pt-4 mt-2">
                <p class="text-xs font-bold text-gray-800 mb-3 text-center uppercase tracking-widest">DADOS DE ACESSO</p>
                <input type="email" id="reg-email" class="w-full border rounded-lg p-3 text-sm mb-2" placeholder="Seu E-mail (Login)">
                <input type="password" id="reg-senha" class="w-full border rounded-lg p-3 text-sm" placeholder="Crie uma Senha (M√≠n. 6 d√≠gitos)">
            </div>

            <button onclick="fazerCadastro()" id="btn-cad" class="w-full btn-primary font-bold py-4 rounded-xl mt-4 flex justify-center items-center gap-2">
                <span>Cadastrar</span><div id="load-cad" class="spinner hidden"></div>
            </button>
        </div>
    </div>

    <!-- TELA 3: LOGIN -->
    <div id="screen-login" class="hidden app-container p-6 fade-in relative flex flex-col justify-center">
        <button onclick="showScreen('welcome')" class="absolute top-4 left-4 text-gray-400 hover:text-blue-700"><i class="fas fa-arrow-left text-xl"></i></button>
        <div class="text-center mb-8"><div class="inline-block p-4 rounded-full bg-blue-50 text-blue-700 mb-4"><i class="fas fa-shield-alt text-3xl"></i></div><h2 class="text-xl font-bold text-gray-800">Login</h2></div>
        
        <div class="space-y-4">
            <input type="email" id="log-email" class="w-full border rounded-lg p-4 text-lg outline-none focus:border-blue-600" placeholder="E-mail">
            <input type="password" id="log-senha" class="w-full border rounded-lg p-4 text-lg outline-none focus:border-blue-600" placeholder="Senha">
            <button onclick="fazerLogin()" id="btn-log" class="w-full btn-primary font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2"><span>Entrar</span><div id="load-log" class="spinner hidden"></div></button>
            <p class="text-center text-xs text-blue-600 cursor-pointer hover:underline mt-4" onclick="resetarSenha()">Esqueci minha senha</p>
        </div>
    </div>
        <!-- TELA 4: O APP (PEDIDO) -->
    <div id="screen-app" class="hidden app-container fade-in relative">
        <div class="bg-blue-700 p-6 text-white relative">
            <div class="flex justify-between items-start mb-4">
                <div><p class="text-xs opacity-80">Ol√°, <span id="app-user-name">...</span></p><p class="text-xs opacity-60">ID: <span id="app-user-code">...</span></p></div>
                <button onclick="fazerLogout()" class="text-xs bg-blue-900 px-3 py-1 rounded-full"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="bg-white/10 p-4 rounded-xl flex justify-between items-center shadow-lg">
                <div><p class="text-xs text-blue-100">Saldo</p><p class="text-2xl font-bold" id="display-saldo">R$ 0,00</p></div>
                <button onclick="abrirRecarga()" class="bg-white px-4 py-2 rounded-lg text-blue-700 text-xs font-bold shadow-lg hover:bg-blue-50 active:scale-95 transition flex items-center gap-1"><i class="fas fa-plus"></i> Add</button>
            </div>
        </div>

        <div class="p-5 space-y-4">
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                <p class="text-[10px] text-center text-blue-500 font-bold uppercase tracking-wider">üìç Rota</p>
                <div class="relative"><i class="fas fa-map-marker-alt text-blue-600 absolute left-3 top-3"></i><input type="text" id="origem" placeholder="Retirada" class="pl-9 bg-white border w-full p-2 text-sm rounded-lg font-bold text-gray-700" readonly></div>
                <div class="relative"><i class="fas fa-flag-checkered text-green-600 absolute left-3 top-3"></i><input type="text" id="destino" placeholder="Entrega (Rua, N√∫mero, Bairro)" class="pl-9 bg-white border w-full p-2 text-sm rounded-lg outline-none focus:border-green-500"></div>
            </div>
            
            <div class="space-y-3">
                <p class="text-[10px] text-center text-gray-400 font-bold uppercase mt-2">üìù Detalhes da Entrega</p>
                
                <!-- DADOS DO CLIENTE FINAL (OBRIGAT√ìRIO) -->
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="nome_dest" placeholder="Nome do Cliente*" class="bg-white border w-full p-2 text-sm rounded-lg outline-none focus:border-blue-500">
                    <input type="text" id="tel_dest" placeholder="WhatsApp do Cliente*" class="bg-white border w-full p-2 text-sm rounded-lg outline-none focus:border-blue-500">
                </div>

                <!-- ENDERE√áO DETALHES (NUMERO REMOVIDO) -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="col-span-1"><input type="text" id="complemento" placeholder="Apto/Bloco" class="bg-white border w-full p-2 text-sm rounded-lg outline-none focus:border-blue-500"></div>
                    <div class="col-span-1"><input type="text" id="referencia" placeholder="Ref.*" class="bg-white border w-full p-2 text-sm rounded-lg outline-none focus:border-blue-500"></div>
                </div>
                
                <!-- MENUS FLUTUANTES -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Entrega</label>
                        <button type="button" class="custom-select-btn border-blue-300 font-bold text-gray-700" onclick="toggleDropdown('entrega')"><span id="display-entrega">üí† PIX</span><i class="fas fa-chevron-down text-xs"></i></button>
                        <input type="hidden" id="pagamento_entrega" value="PIX">
                        <div id="list-entrega" class="custom-options"><div class="custom-option" onclick="selectOption('entrega', 'PIX', 'üí† PIX')">üí† PIX</div><div class="custom-option" onclick="selectOption('entrega', 'Dinheiro', 'üíµ Dinheiro')">üíµ Dinheiro</div><div class="custom-option" onclick="selectOption('entrega', 'Carteira', 'üí≥ Saldo em Conta')">üí≥ Saldo em Conta</div></div>
                    </div>
                    <div class="relative">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Produto</label>
                        <button type="button" class="custom-select-btn border-green-300 text-gray-700" onclick="toggleDropdown('produto')"><span id="display-produto">‚úÖ J√° Pago</span><i class="fas fa-chevron-down text-xs"></i></button>
                        <input type="hidden" id="pagamento_produto" value="J√° Pago">
                        <div id="list-produto" class="custom-options"><div class="custom-option" onclick="selectOption('produto', 'J√° Pago', '‚úÖ J√° Pago')">‚úÖ J√° Pago</div><div class="custom-option" onclick="selectOption('produto', 'Cart√£o', 'üí≥ Cart√£o')">üí≥ Cart√£o</div><div class="custom-option" onclick="selectOption('produto', 'PIX', 'üí† PIX')">üí† PIX</div><div class="custom-option" onclick="selectOption('produto', 'Dinheiro', 'üíµ Dinheiro')">üíµ Dinheiro</div></div>
                    </div>
                </div>
                
                <div id="box-retorno" class="switch-container bg-white border border-gray-200">
                    <div class="flex items-center gap-2"><i id="icon-retorno" class="fas fa-arrow-right text-gray-400"></i><span id="text-retorno" class="text-sm font-bold text-gray-500">Sem retorno!</span></div>
                    <label class="switch"><input type="checkbox" id="retorno" onchange="recalcularTotal(); mudarStatusRetorno()"><span class="slider"></span></label>
                </div>
            </div>
            <button onclick="calcularDistancia()" id="btn-calcular" class="w-full btn-primary font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2"><span id="btn-text">Calcular Frete</span><div id="loading" class="spinner hidden"></div></button>
            <div id="resultado-box" class="hidden bg-green-50 border border-green-200 p-4 rounded-xl flex justify-between items-center animate-pulse">
                <div><p class="text-xs text-gray-500">Dist√¢ncia</p><p class="font-bold text-gray-800"><span id="km-display">0</span> km</p></div>
                <div class="text-right"><p class="text-xs text-gray-500">Total Frete</p><p class="font-bold text-2xl text-green-700">R$ <span id="valor-display">0,00</span></p></div>
            </div>
            <button onclick="enviarParaCentral()" id="btn-enviar" class="hidden w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2"><i class="fab fa-whatsapp text-2xl"></i> Confirmar Pedido</button>
        </div>
    </div>

    <!-- TELA 5: HIST√ìRICO -->
    <div id="screen-history" class="hidden app-container fade-in relative flex flex-col"><div class="bg-blue-700 p-4 text-white text-center font-bold">Meus Pedidos</div><div id="lista-pedidos" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div></div>
    
    <!-- TELA 6: EXTRATO -->
    <div id="screen-extract" class="hidden app-container fade-in relative flex flex-col"><div class="bg-blue-700 p-4 text-white text-center font-bold">Extrato Financeiro</div><div class="bg-blue-800 p-6 text-center text-white"><p class="text-xs opacity-70 uppercase tracking-wider">Saldo Atual</p><p class="text-3xl font-bold" id="saldo-extrato">R$ 0,00</p></div><div id="lista-extrato" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div></div>
    
    <!-- TELA 7: PERFIL DETALHADO -->
    <div id="screen-profile" class="hidden app-container fade-in relative"><div class="bg-gray-800 p-4 text-white text-center font-bold">Meu Perfil</div><div class="p-6 space-y-5">
        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">NOME DO ESTABELECIMENTO</label><input type="text" id="perf-nome-loja" class="w-full bg-gray-50 border rounded-lg p-3 text-sm"></div>
        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">WHATSAPP DA LOJA</label><input type="text" id="perf-zap" class="w-full bg-gray-50 border rounded-lg p-3 text-sm"></div>
        <div><label class="text-[10px] font-bold text-gray-500 uppercase ml-1">NOME DO RESPONS√ÅVEL</label><input type="text" id="perf-nome-resp" class="w-full bg-gray-50 border rounded-lg p-3 text-sm"></div>
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><p class="text-xs font-bold text-blue-700 mb-1">ENDERE√áO DE COLETA</p><div class="relative mb-2"><input type="text" id="perf-cep" onblur="buscarCep('perf')" class="w-full border rounded-lg p-2 text-sm pl-8"><i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i></div><input type="text" id="perf-rua" class="w-full border rounded-lg p-2 text-sm mb-2 bg-white/70" readonly><div class="grid grid-cols-3 gap-2 mb-2"><div class="col-span-1"><input type="text" id="perf-num" class="w-full border rounded-lg p-2 text-sm" placeholder="N¬∫"></div><div class="col-span-2"><input type="text" id="perf-bairro" class="w-full border rounded-lg p-2 text-sm" readonly></div></div><input type="text" id="perf-cidade" class="w-full border rounded-lg p-2 text-sm" readonly></div>
        <button onclick="salvarPerfil()" id="btn-salvar-perf" class="w-full btn-primary font-bold py-3 rounded-xl shadow-lg flex justify-center items-center gap-2"><span>Salvar Altera√ß√µes</span><div id="loading-perf" class="spinner hidden"></div></button>
    </div></div>

    <!-- MODAL SUCESSO -->
    <div id="modal-success" class="hidden fixed inset-0 bg-green-900/90 z-[60] flex items-center justify-center p-4 fade-in"><div class="bg-white rounded-3xl p-8 text-center w-full max-w-xs shadow-2xl"><div class="mx-auto bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mb-4"><i class="fas fa-check text-4xl text-green-600"></i></div><h2 class="text-2xl font-bold text-gray-800 mb-2">Pedido Enviado!</h2><p class="text-sm text-gray-500 mb-6">Entregue este c√≥digo ao motoboy:</p><div class="bg-gray-100 p-4 rounded-xl border-2 border-dashed border-gray-300 mb-6"><p class="text-xs text-gray-400 uppercase tracking-widest mb-1">PIN DE SEGURAN√áA</p><p id="display-pin" class="text-4xl font-mono font-bold text-blue-600 tracking-widest">0000</p></div><button onclick="location.reload()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">Fechar</button></div></div>

    <!-- MODAL RECARGA -->
    <div id="modal-recarga" class="hidden absolute inset-0 bg-black/90 z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center"><h3 class="font-bold text-lg mb-2">Recarregar Saldo</h3><div id="step-valor"><input type="number" id="valor-recarga" class="w-full border rounded-lg p-3 text-center text-xl font-bold mb-4" placeholder="R$ 0,00"><button onclick="gerarPixRecarga()" class="w-full btn-primary font-bold py-3 rounded-xl">Gerar Pix</button></div><div id="step-qr" class="hidden"><div id="qrcode-container" class="flex justify-center mb-4 p-2 border rounded-lg"></div><textarea id="pix-copia-cola" class="w-full text-[10px] bg-gray-100 p-2 rounded mb-2 h-16 text-gray-500" readonly></textarea><button onclick="copiarPix()" class="w-full bg-green-600 text-white text-sm font-bold py-2 rounded-lg mb-2">Copiar C√≥digo</button></div><div id="loading-pix" class="hidden py-4"><div class="spinner mx-auto"></div></div><button onclick="fecharRecarga()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>
        <!-- MENU INFERIOR -->
    <div id="bottom-menu" class="hidden bottom-nav w-full max-w-md"><div class="nav-item active" onclick="navegar('app', this)"><i class="fas fa-home"></i><span>In√≠cio</span></div><div class="nav-item" onclick="navegar('history', this); carregarHistorico()"><i class="fas fa-list"></i><span>Pedidos</span></div><div class="nav-item" onclick="navegar('extract', this); carregarExtrato()"><i class="fas fa-file-invoice-dollar"></i><span>Extrato</span></div><div class="nav-item" onclick="navegar('profile', this); abrirPerfil()"><i class="fas fa-user"></i><span>Perfil</span></div></div>

    <script>
        $(document).ready(function(){ 
            $('#reg-zap-loja').mask('(00) 00000-0000'); $('#reg-zap-resp').mask('(00) 00000-0000'); $('#perf-zap').mask('(00) 00000-0000'); $('#reg-cep').mask('00000-000'); $('#perf-cep').mask('00000-000');
            $('#tel_dest').mask('(00) 00000-0000'); 
        });

        // VALIDAR TELEFONE
        function validarTelefone(tel) {
            const limpo = tel.replace(/\D/g, '');
            if(limpo.length !== 11) return false;
            if(parseInt(limpo.substring(2, 3)) !== 9) return false; // Exige 9
            return true;
        }

        function toggleDropdown(id) { const list = document.getElementById(`list-${id}`); if(id === 'entrega') document.getElementById('list-produto').classList.remove('show'); else document.getElementById('list-entrega').classList.remove('show'); list.classList.toggle('show'); }
        function selectOption(id, value, text) { document.getElementById(`pagamento_${id}`).value = value; document.getElementById(`display-${id}`).innerText = text; document.getElementById(`list-${id}`).classList.remove('show'); }
        document.addEventListener('click', function(e) { if (!e.target.closest('.relative')) { document.querySelectorAll('.custom-options').forEach(el => el.classList.remove('show')); } });

        function showScreen(id) { ['welcome', 'register', 'login', 'app', 'history', 'extract', 'profile'].forEach(s => document.getElementById('screen-'+s).classList.add('hidden')); document.getElementById('screen-'+id).classList.remove('hidden'); if(['app', 'history', 'extract', 'profile'].includes(id)) { document.getElementById('bottom-menu').classList.remove('hidden'); document.getElementById('bottom-menu').classList.add('flex'); } else { document.getElementById('bottom-menu').classList.add('hidden'); document.getElementById('bottom-menu').classList.remove('flex'); } }
        function navegar(tela, elemento) { showScreen(tela); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); elemento.classList.add('active'); }

        // --- CADASTRO ---
        async function fazerCadastro() {
            const email = document.getElementById('reg-email').value; const senha = document.getElementById('reg-senha').value; const loja = document.getElementById('reg-nome-loja').value; const zap = document.getElementById('reg-zap-loja').value; const resp = document.getElementById('reg-nome-resp').value; const zapResp = document.getElementById('reg-zap-resp').value; const cep = document.getElementById('reg-cep').value; const rua = document.getElementById('reg-rua').value; const num = document.getElementById('reg-num').value; const bairro = document.getElementById('reg-bairro').value; const cidade = document.getElementById('reg-cidade').value;
            const btn = document.getElementById('btn-cad'); const load = document.getElementById('load-cad');

            if(!email || !senha || !loja || !num) { alert("Preencha tudo."); return; }
            if(!validarTelefone(zap)) { alert("WhatsApp Loja inv√°lido!"); return; }
            if(!validarTelefone(zapResp)) { alert("WhatsApp Respons√°vel inv√°lido!"); return; }
            if(senha.length < 6) { alert("Senha curta."); return; }

            btn.disabled = true; load.classList.remove('hidden');

            try {
                const { data, error } = await sbClient.auth.signUp({
                    email: email, password: senha,
                    options: { data: { nome_loja: loja, whatsapp: zap, responsavel: resp, cep: cep, endereco: `${rua}, ${num}, ${bairro}`, numero: num, bairro: bairro, cidade: cidade } }
                });
                if (error) throw error;
                alert("Conta criada! Entrando...");
                userSession = data.session; await carregarPerfil(); showScreen('app');
            } catch (error) { alert("Erro: " + error.message); } 
            finally { btn.disabled = false; load.classList.add('hidden'); }
        }

        // --- LOGIN ---
        async function fazerLogin() {
            const email = document.getElementById('log-email').value; const senha = document.getElementById('log-senha').value;
            const btn = document.getElementById('btn-log'); const load = document.getElementById('load-log');
            btn.disabled = true; load.classList.remove('hidden');
            try {
                const { data, error } = await sbClient.auth.signInWithPassword({ email: email, password: senha });
                if (error) throw error;
                userSession = data.session; await carregarPerfil(); showScreen('app');
            } catch (error) { alert("Login falhou."); } 
            finally { btn.disabled = false; load.classList.add('hidden'); }
        }

        async function carregarPerfil() {
            const { data: { user } } = await sbClient.auth.getUser();
            const { data } = await sbClient.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                userProfile = data;
                safeText('app-user-name', data.nome_loja);
                safeText('app-user-code', data.codigo_visual || '...');
                safeText('display-saldo', "R$ " + (data.saldo || 0).toFixed(2));
                safeText('saldo-extrato', "R$ " + (data.saldo || 0).toFixed(2));
                document.getElementById('origem').value = data.endereco || data.nome_loja;
                monitorarSaldo();
            }
        }
        
        function safeText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }

        async function resetarSenha() { const email = prompt("Digite seu e-mail:"); if(email) { const { error } = await sbClient.auth.resetPasswordForEmail(email); alert(error ? "Erro." : "Verifique seu e-mail."); } }
        function fazerLogout() { sbClient.auth.signOut(); location.reload(); }
        async function buscarCep(prefixo) { let cep = document.getElementById(prefixo + '-cep').value.replace(/\D/g, ''); if(cep.length !== 8) return; try { const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const data = await res.json(); if(!data.erro) { document.getElementById(prefixo + '-rua').value = data.logradouro; document.getElementById(prefixo + '-bairro').value = data.bairro; document.getElementById(prefixo + '-cidade').value = `${data.localidade}/${data.uf}`; document.getElementById(prefixo + '-num').focus(); } } catch(e){} }
        function monitorarSaldo() { sbClient.channel('custom-all-channel').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${userSession.user.id}` }, (payload) => { document.getElementById('display-saldo').innerText = "R$ " + payload.new.saldo.toFixed(2); document.getElementById('saldo-extrato').innerText = "R$ " + payload.new.saldo.toFixed(2); }).subscribe(); }
               // --- APP ---
        async function carregarHistorico() { const div = document.getElementById('lista-pedidos'); div.innerHTML = '<p class="text-center text-gray-400 mt-4"><i class="fas fa-spinner fa-spin"></i></p>'; const { data } = await sbClient.from('pedidos').select('*').eq('user_id', userSession.user.id).order('created_at', { ascending: false }).limit(20); div.innerHTML = ''; if(!data?.length) { div.innerHTML = '<p class="text-center text-gray-400 mt-4">Sem pedidos.</p>'; return; } data.forEach(p => { const date = new Date(p.created_at).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}); div.innerHTML += `<div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm mb-2"><div class="flex justify-between mb-1"><span class="font-bold text-gray-700 w-2/3 truncate">${p.destino}</span><span class="font-bold text-blue-600">R$ ${p.valor_frete}</span></div><div class="flex justify-between text-xs text-gray-500 mb-2"><span>${date}</span><span>${p.forma_pagamento}</span></div><div class="bg-blue-50 p-2 rounded text-center border border-blue-100"><p class="text-[10px] text-blue-800 uppercase font-bold">C√≥digo de Recebimento</p><p class="text-xl font-mono font-bold text-blue-600 tracking-widest">${p.pin_entrega || '---'}</p></div></div>`; }); }
        async function carregarExtrato() { const div = document.getElementById('lista-extrato'); div.innerHTML = '<p class="text-center text-gray-400 mt-4"><i class="fas fa-spinner fa-spin"></i></p>'; const { data } = await sbClient.from('transacoes').select('*').eq('user_id', userSession.user.id).order('created_at', { ascending: false }).limit(20); div.innerHTML = ''; if(!data?.length) { div.innerHTML = '<p class="text-center text-gray-400 mt-4">Sem transa√ß√µes.</p>'; return; } data.forEach(t => { const date = new Date(t.created_at).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}); const cor = t.tipo === 'entrada' ? 'text-green-600' : 'text-red-600'; const sinal = t.tipo === 'entrada' ? '+' : '-'; div.innerHTML += `<div class="bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center mb-2"><div><p class="text-sm font-bold text-gray-700">${t.descricao}</p><p class="text-xs text-gray-400">${date}</p></div><p class="font-bold ${cor}">${sinal} R$ ${t.valor}</p></div>`; }); }

        async function calcularDistancia() {
            const origem = document.getElementById('origem').value; const destino = document.getElementById('destino').value;
            if(!origem || !destino) return alert("Preencha endere√ßos");
            document.getElementById('btn-text').innerText = "Calculando..."; document.getElementById('loading').classList.remove('hidden'); document.getElementById('btn-calcular').classList.add('opacity-50');
            try {
                const urlA = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(origem + ', ' + CIDADE_FIXA)}`;
                const urlB = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destino + ', ' + CIDADE_FIXA)}`;
                const [resA, resB] = await Promise.all([fetch(urlA), fetch(urlB)]);
                const [dataA, dataB] = await Promise.all([resA.json(), resB.json()]);
                if(!dataA.length || !dataB.length) { alert("Endere√ßo n√£o achado."); resetBotao(); return; }
                const dist = getDistanceFromLatLonInKm(dataA[0].lat, dataA[0].lon, dataB[0].lat, dataB[0].lon);
                distanciaFinal = (dist * 1.3).toFixed(1); if(distanciaFinal < 1) distanciaFinal = 1;
                recalcularTotal();
                document.getElementById('btn-calcular').classList.add('hidden'); document.getElementById('resultado-box').classList.remove('hidden'); document.getElementById('btn-enviar').classList.remove('hidden'); document.getElementById('resultado-box').classList.remove('animate-pulse');
            } catch (e) { alert("Erro conex√£o."); resetBotao(); }
        }
        function resetBotao() { document.getElementById('btn-text').innerText = "Calcular Frete"; document.getElementById('loading').classList.add('hidden'); document.getElementById('btn-calcular').classList.remove('opacity-50'); }
        function recalcularTotal() { if(distanciaFinal == 0) return; let preco = PRECO_BASE + (distanciaFinal * PRECO_POR_KM); if(document.getElementById('retorno').checked) preco += (preco * TAXA_RETORNO); valorFinal = preco.toFixed(2); document.getElementById('km-display').innerText = distanciaFinal.replace('.', ','); document.getElementById('valor-display').innerText = valorFinal.replace('.', ','); }
        function mudarStatusRetorno() { const checked = document.getElementById('retorno').checked; const txt = document.getElementById('text-retorno'); const ico = document.getElementById('icon-retorno'); if(checked) { txt.innerText = "Sim, com retorno!"; txt.classList.replace('text-gray-500', 'text-blue-700'); ico.className = "fas fa-exchange-alt text-blue-600"; } else { txt.innerText = "Sem retorno!"; txt.classList.replace('text-blue-700', 'text-gray-500'); ico.className = "fas fa-arrow-right text-gray-400"; } }

        async function enviarParaCentral() {
            const pgEnt = document.getElementById('pagamento_entrega').value;
            const pgProd = document.getElementById('pagamento_produto').value;
            const ret = document.getElementById('retorno').checked ? "COM RETORNO" : "SEM RETORNO";
            
            // NOVOS CAMPOS (SEM NUMERO)
            const nomeDest = document.getElementById('nome_dest').value;
            const telDest = document.getElementById('tel_dest').value;
            const ref = document.getElementById('referencia').value;

            // VALIDA√á√ÉO RIGOROSA
            if(!nomeDest || !telDest || !ref) { alert("Preencha todos os detalhes do cliente e refer√™ncia."); return; }
            if(!validarTelefone(telDest)) { alert("WhatsApp do Cliente inv√°lido!"); return; }

            if(pgEnt === "Carteira") {
                const val = parseFloat(valorFinal);
                if(val > (userProfile.saldo || 0)) return alert("Saldo insuficiente.");
                const novoSaldo = userProfile.saldo - val;
                const { error } = await sbClient.from('profiles').update({ saldo: novoSaldo }).eq('id', userSession.user.id);
                if(error) return alert("Erro no d√©bito.");
                await sbClient.from('transacoes').insert([{ user_id: userSession.user.id, tipo: 'saida', valor: val, descricao: 'Envio: ' + document.getElementById('destino').value }]);
                userProfile.saldo = novoSaldo;
                document.getElementById('display-saldo').innerText = "R$ " + novoSaldo.toFixed(2);
            }

            const pinSeguranca = Math.floor(1000 + Math.random() * 9000).toString();
            
            // SALVA NOVO PEDIDO COM DADOS DO DESTINATARIO
            await sbClient.from('pedidos').insert([{
                user_id: userSession.user.id,
                origem: document.getElementById('origem').value,
                destino: document.getElementById('destino').value,
                valor_frete: parseFloat(valorFinal),
                forma_pagamento: pgEnt,
                pin_entrega: pinSeguranca,
                nome_destinatario: nomeDest, 
                telefone_destinatario: telDest
            }]);

            // MODAL SUCESSO
            document.getElementById('display-pin').innerText = pinSeguranca;
            document.getElementById('modal-success').classList.remove('hidden');

            const numAdmin = NUMERO_ADMIN; 
            let avisoPagamento = pgEnt === "Carteira" ? "‚úÖ *PAGO VIA CARTEIRA*" : `üõµ *Pgto Entrega:* ${pgEnt}`;
            let valorParaMotoboy = parseFloat(valorFinal) - TAXA_FIXA_CENTRAL; if(valorParaMotoboy < 4) valorParaMotoboy = 4;
            let proto = valorParaMotoboy.toFixed(2).replace('.', ''); while(proto.length < 5) proto = "0" + proto;
            
            // MENSAGEM WHATSAPP SEM O CAMPO N√öMERO
            const msg = `üö® *NOVA CORRIDA* üö®%0A%0Aüë§ *Loja:* ${userProfile.nome_loja} (C√≥d: ${userProfile.codigo_visual})%0Aüì¶ *Cliente:* ${nomeDest || 'N√£o inf.'} (${telDest || ''})%0Aüìç *DE:* ${document.getElementById('origem').value}%0AüèÅ *PARA:* ${document.getElementById('destino').value}%0A${document.getElementById('complemento').value ? 'üè¢ ' + document.getElementById('complemento').value + '%0A' : ''}${document.getElementById('referencia').value ? 'üèõÔ∏è ' + document.getElementById('referencia').value + '%0A' : ''}--------------------------------%0Aüìè ${distanciaFinal}km | üîÑ ${ret}%0A${avisoPagamento}%0Aüì¶ *Pgto Produto:* ${pgProd}%0Aüí≤ *FRETE: R$ ${valorFinal}*%0Aüîë *Prot:* %23${proto}%0Aüîí *PIN:* ${pinSeguranca}`;
            
            window.open(`https://wa.me/${numAdmin}?text=${msg}`, '_blank');
        }
                // PERFIL (SALVAR)
        function abrirPerfil() { document.getElementById('perf-nome-loja').value = userProfile.nome_loja || ""; document.getElementById('perf-nome-resp').value = userProfile.responsavel || ""; document.getElementById('perf-zap').value = userProfile.whatsapp || ""; document.getElementById('perf-cep').value = userProfile.cep || ""; document.getElementById('perf-rua').value = userProfile.endereco ? userProfile.endereco.split(',')[0] : ""; document.getElementById('perf-num').value = userProfile.numero || ""; document.getElementById('perf-bairro').value = userProfile.bairro || ""; document.getElementById('perf-cidade').value = userProfile.cidade || ""; showScreen('profile'); }
        async function salvarPerfil() {
            const loja = document.getElementById('perf-nome-loja').value; const resp = document.getElementById('perf-nome-resp').value; const zap = document.getElementById('perf-zap').value; const cep = document.getElementById('perf-cep').value; const rua = document.getElementById('perf-rua').value; const num = document.getElementById('perf-num').value; const bairro = document.getElementById('perf-bairro').value; const cidade = document.getElementById('perf-cidade').value; const endereco = `${rua}, ${num}, ${bairro}`;
            const btn = document.getElementById('btn-salvar-perf'); const load = document.getElementById('loading-perf'); btn.disabled = true; load.classList.remove('hidden');
            try {
                const { error } = await sbClient.from('profiles').update({ nome_loja: loja, responsavel: resp, whatsapp: zap, cep: cep, endereco: endereco, numero: num, bairro: bairro, cidade: cidade }).eq('id', userSession.user.id);
                if(error) throw error; alert("Salvo!"); await carregarPerfil(); showScreen('app');
            } catch(e) { alert("Erro ao salvar."); } finally { btn.disabled = false; load.classList.add('hidden'); }
        }
        function abrirRecarga() { document.getElementById('modal-recarga').classList.remove('hidden'); }
        function fecharRecarga() { document.getElementById('modal-recarga').classList.add('hidden'); }
        async function gerarPixRecarga() {
            const valor = parseFloat(document.getElementById('valor-recarga').value); if(!valor || valor < 5) { alert("M√≠nimo R$ 5,00"); return; } if(!MAKE_WEBHOOK_URL) { alert("Recarga indispon√≠vel."); return; } document.getElementById('step-valor').classList.add('hidden'); document.getElementById('loading-pix').classList.remove('hidden');
            try { const res = await fetch(MAKE_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userSession.user.id, valor: valor, nome: userProfile.nome_loja, origem: "Drop App" }) }); const data = await res.json(); if(data.payload) { document.getElementById('loading-pix').classList.add('hidden'); document.getElementById('step-qr').classList.remove('hidden'); document.getElementById('pix-copia-cola').value = data.payload; document.getElementById('qrcode-container').innerHTML = ""; new QRCode(document.getElementById("qrcode-container"), { text: data.payload, width: 128, height: 128 }); } else { alert("Erro ao gerar Pix."); fecharRecarga(); } } catch(e) { alert("Erro de comunica√ß√£o."); fecharRecarga(); }
        }
        function copiarPix() { document.getElementById('pix-copia-cola').select(); document.execCommand("copy"); alert("Copiado!"); }
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) { var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function deg2rad(deg) { return deg * (Math.PI/180); }
    </script>
</body>
</html>
